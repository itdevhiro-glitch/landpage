<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Petty Cash - Zeppelin Finance</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* --- PROFESSIONAL THEME VARIABLES --- */
        :root {
            --primary: #D9232D;
            --primary-dark: #b91c1c;
            --accent: #F37321;
            --bg-body: #f8fafc; /* Cool Grey Light */
            --bg-card: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 10px;
        }

        /* --- BASE RESET --- */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); line-height: 1.5; -webkit-font-smoothing: antialiased; }
        
        /* --- LAYOUT UTILS --- */
        .container { max-width: 1100px; margin: 0 auto; padding: 0 20px; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .flex-gap { display: flex; gap: 12px; }
        .hidden { display: none !important; }

        /* --- NAVBAR (Clean Style) --- */
        .navbar { background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 14px 0; position: sticky; top: 0; z-index: 50; }
        .nav-inner { display: flex; align-items: center; justify-content: space-between; }
        .brand { display: flex; align-items: center; gap: 10px; text-decoration: none; font-weight: 700; font-size: 1.1rem; color: var(--text-main); letter-spacing: -0.5px; }
        .brand i { color: var(--primary); font-size: 1.25rem; }
        .nav-btn-back { color: var(--text-muted); text-decoration: none; font-size: 0.875rem; font-weight: 500; display: flex; align-items: center; gap: 6px; transition: 0.2s; padding: 8px 12px; border-radius: 6px; }
        .nav-btn-back:hover { background: #f1f5f9; color: var(--primary); }

        /* --- HEADER AREA --- */
        .page-header { margin: 32px 0 24px; }
        .page-title { font-size: 1.5rem; font-weight: 700; color: var(--text-main); letter-spacing: -0.025em; margin-bottom: 4px; }
        .page-subtitle { color: var(--text-muted); font-size: 0.925rem; }

        /* --- STATS CARDS (Modern) --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--bg-card); padding: 24px; border-radius: 12px; border: 1px solid var(--border); box-shadow: var(--shadow-sm); display: flex; flex-direction: column; justify-content: space-between; position: relative; overflow: hidden; }
        .stat-label { font-size: 0.85rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--text-main); margin-top: 8px; font-family: 'JetBrains Mono', monospace; letter-spacing: -1px; }
        .stat-icon-bg { position: absolute; bottom: -10px; right: -10px; font-size: 5rem; opacity: 0.05; color: var(--text-main); transform: rotate(-15deg); }
        .border-top-primary { border-top: 4px solid var(--primary); }
        
        /* --- ACTION BAR --- */
        .action-toolbar { background: var(--bg-card); padding: 16px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 24px; box-shadow: var(--shadow-sm); display: flex; gap: 16px; flex-wrap: wrap; }
        .search-wrapper { flex: 1; position: relative; min-width: 200px; }
        .search-wrapper i { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 0.9rem; }
        .search-input { width: 100%; padding: 10px 16px 10px 40px; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 0.925rem; outline: none; transition: 0.2s; }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(217, 35, 45, 0.1); }
        
        .btn { border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; font-size: 0.925rem; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s; font-family: 'Inter', sans-serif; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px -2px rgba(217, 35, 45, 0.3); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-primary:active { transform: translateY(0); }

        /* --- DATA TABLE (Professional) --- */
        .table-container { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; box-shadow: var(--shadow-sm); }
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #f8fafc; text-align: left; padding: 14px 20px; font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); }
        td { padding: 16px 20px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; color: #334155; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background-color: #fcfcfc; }
        
        .col-date { color: var(--text-muted); font-variant-numeric: tabular-nums; width: 15%; }
        .col-money { font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--text-main); text-align: left; width: 20%; }
        .col-cat { width: 15%; }
        .category-badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
        
        /* Action Buttons */
        .action-btn { background: none; border: none; width: 32px; height: 32px; border-radius: 6px; color: #94a3b8; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; font-size: 0.9rem; }
        .action-btn:hover { background: #f1f5f9; color: var(--text-main); }
        .action-btn.delete:hover { background: #fef2f2; color: #ef4444; }
        .action-btn.edit:hover { background: #fff7ed; color: #f97316; }

        /* --- LOADING & MODAL --- */
        .loading-overlay { position: fixed; inset: 0; background: white; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.4s; }
        .spinner { width: 40px; height: 40px; border: 3px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .modal-backdrop { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(4px); z-index: 200; display: none; opacity: 0; transition: opacity 0.3s; }
        .modal-card { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -48%) scale(0.96); width: 90%; max-width: 480px; background: white; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); z-index: 201; display: none; opacity: 0; transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); border: 1px solid rgba(255,255,255,0.1); }
        
        .modal-backdrop.active, .modal-card.active { display: block; opacity: 1; }
        .modal-card.active { transform: translate(-50%, -50%) scale(1); }
        
        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f8fafc; border-radius: 16px 16px 0 0; }
        .modal-header h3 { font-size: 1.1rem; font-weight: 700; color: var(--text-main); }
        .close-modal { background: none; border: none; color: #94a3b8; cursor: pointer; font-size: 1.25rem; transition: 0.2s; }
        .close-modal:hover { color: var(--primary); }
        
        .modal-body { padding: 24px; }
        .form-group { margin-bottom: 18px; }
        .form-label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-main); margin-bottom: 6px; }
        .form-input { width: 100%; padding: 11px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 0.95rem; outline: none; transition: 0.2s; background: #fff; }
        .form-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(217, 35, 45, 0.1); }
        .btn-full { width: 100%; justify-content: center; padding: 12px; margin-top: 10px; }

        /* --- TOAST NOTIFICATION --- */
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px); background: #1e293b; color: white; padding: 12px 24px; border-radius: 50px; font-size: 0.9rem; font-weight: 500; display: flex; align-items: center; gap: 10px; opacity: 0; visibility: hidden; transition: all 0.3s; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); z-index: 3000; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; visibility: visible; }
        .toast i { color: #4ade80; }

        /* Empty State */
        .empty-state { padding: 60px 20px; text-align: center; color: var(--text-muted); }
        .empty-icon { font-size: 3rem; color: #e2e8f0; margin-bottom: 15px; }

        @media (max-width: 640px) {
            .navbar { padding: 12px 0; }
            .action-toolbar { flex-direction: column-reverse; gap: 12px; }
            .btn { width: 100%; justify-content: center; }
            .stat-value { font-size: 1.5rem; }
        }
    </style>
</head>
<body>

    <div id="loading-screen" class="loading-overlay">
        <div class="spinner"></div>
        <p style="margin-top: 16px; font-weight: 500; color: #64748b; font-size: 0.9rem;">Memuat Data Keuangan...</p>
    </div>

    <nav class="navbar">
        <div class="container nav-inner">
            <div class="flex-gap" style="align-items: center;">
                <a href="finance.html" class="nav-btn-back">
                    <i class="fa-solid fa-chevron-left"></i> Dashboard
                </a>
                <span style="color: #cbd5e1;">|</span>
                <a href="#" class="brand">
                    <i class="fa-solid fa-wallet"></i> Petty Cash
                </a>
            </div>
            <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-main); display: flex; align-items: center; gap: 8px;">
                <div style="width: 28px; height: 28px; background: #fee2e2; color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem;">
                    <i class="fa-solid fa-user"></i>
                </div>
                <span id="user-display" class="hidden-mobile">Finance Team</span>
            </div>
        </div>
    </nav>

    <div class="container">
        
        <header class="page-header">
            <h1 class="page-title">Kas Operasional</h1>
            <p class="page-subtitle">Kelola pengeluaran harian dan pencatatan kas kecil.</p>
        </header>

        <div class="stats-grid">
            <div class="stat-card border-top-primary">
                <div class="stat-label">Total Pengeluaran (Bulan Ini)</div>
                <div class="stat-value" id="total-expense" style="color: var(--primary);">Rp 0</div>
                <i class="fa-solid fa-money-bill-wave stat-icon-bg"></i>
            </div>
            <div class="stat-card" style="border-top: 4px solid var(--accent);">
                <div class="stat-label">Total Transaksi</div>
                <div class="stat-value" id="total-trx">0</div>
                <i class="fa-solid fa-receipt stat-icon-bg"></i>
            </div>
        </div>

        <div class="action-toolbar">
            <div class="search-wrapper">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="search-input" class="search-input" placeholder="Cari keterangan, kategori, atau nominal...">
            </div>
            <button class="btn btn-primary" onclick="openModal()">
                <i class="fa-solid fa-plus"></i> Catat Pengeluaran
            </button>
        </div>

        <div class="table-container">
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Keterangan</th>
                            <th>Kategori</th>
                            <th>Nominal</th>
                            <th style="text-align: right;">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="pc-table-body">
                        </tbody>
                </table>
            </div>
            <div id="empty-state" class="empty-state hidden">
                <i class="fa-solid fa-clipboard-list empty-icon"></i>
                <p>Belum ada data pengeluaran bulan ini.</p>
            </div>
        </div>

        <div style="margin-top: 40px; text-align: center; color: #94a3b8; font-size: 0.8rem;">
            &copy; 2025 Zeppelin Finance System. Secure Data.
        </div>
    </div>

    <div id="modal-backdrop" class="modal-backdrop"></div>
    <div id="modal-content" class="modal-card">
        <div class="modal-header">
            <h3 id="modal-title">Pengeluaran Baru</h3>
            <button class="close-modal" onclick="closeModal()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="trx-id">
            
            <div class="form-group">
                <label class="form-label">Tanggal Transaksi</label>
                <input type="date" id="trx-date" class="form-input">
            </div>

            <div class="form-group">
                <label class="form-label">Keperluan / Keterangan</label>
                <input type="text" id="trx-desc" class="form-input" placeholder="Contoh: Beli Kertas A4 & Tinta">
            </div>

            <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label class="form-label">Kategori</label>
                    <select id="trx-cat" class="form-input">
                        <option value="Operasional">Operasional</option>
                        <option value="Konsumsi">Konsumsi</option>
                        <option value="ATK">ATK</option>
                        <option value="Transport">Transport</option>
                        <option value="Lainnya">Lainnya</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">Nominal (Rp)</label>
                    <input type="number" id="trx-amount" class="form-input" placeholder="0">
                </div>
            </div>

            <button class="btn btn-primary btn-full" onclick="saveTransaction()">
                Simpan Transaksi
            </button>
        </div>
    </div>

    <div id="toast" class="toast">
        <i class="fa-solid fa-circle-check"></i>
        <span id="toast-msg">Data berhasil disimpan</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getDatabase, ref, onValue, push, set, remove, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // Config Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA9wgSalrlTcveIZi2i-WND86z1i9JYHKw",
            authDomain: "it-support-53eeb.firebaseapp.com",
            databaseURL: "https://it-support-53eeb-default-rtdb.firebaseio.com",
            projectId: "it-support-53eeb",
            storageBucket: "it-support-53eeb.firebasestorage.app",
            messagingSenderId: "573924501146",
            appId: "1:573924501146:web:12f34306ed675472322123",
            measurementId: "G-33K6DDE1VR"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let pettyCashData = [];

        // 1. AUTH & SECURITY
        onAuthStateChanged(auth, (user) => {
            if (user) {
                const userRef = ref(db, 'users/' + user.uid);
                get(userRef).then((snapshot) => {
                    const data = snapshot.val();
                    const isFinance = (data.departemen && (data.departemen.includes('Finance') || data.departemen.includes('Accounting') || user.email === 'root@zeppelin.center'));
                    
                    if (isFinance) {
                        document.getElementById('user-display').textContent = data.nama || "Finance Team";
                        document.getElementById('loading-screen').style.opacity = '0';
                        setTimeout(() => document.getElementById('loading-screen').style.display = 'none', 400);
                        initPettyCashListener();
                    } else {
                        alert("Akses Ditolak. Khusus Finance.");
                        window.location.href = 'dashboard.html';
                    }
                });
            } else {
                window.location.href = 'index.html';
            }
        });

        // 2. READ DATA
        function initPettyCashListener() {
            const pcRef = ref(db, 'finance_pettycash');
            onValue(pcRef, (snapshot) => {
                pettyCashData = [];
                const data = snapshot.val();
                if (data) {
                    Object.keys(data).forEach(key => {
                        pettyCashData.push({ id: key, ...data[key] });
                    });
                }
                pettyCashData.sort((a, b) => new Date(b.date) - new Date(a.date));
                renderTable(pettyCashData);
                updateStats(pettyCashData);
            });
        }

        // 3. RENDER TABLE
        function renderTable(data) {
            const tbody = document.getElementById('pc-table-body');
            const emptyState = document.getElementById('empty-state');
            tbody.innerHTML = '';

            if (data.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            } else {
                emptyState.classList.add('hidden');
            }

            data.forEach(item => {
                const tr = document.createElement('tr');
                
                // Format Date nicely
                const dateObj = new Date(item.date);
                const dateStr = dateObj.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                
                // Format Money
                const moneyStr = parseInt(item.amount).toLocaleString('id-ID');

                tr.innerHTML = `
                    <td class="col-date">${dateStr}</td>
                    <td style="font-weight: 500;">${item.desc}</td>
                    <td class="col-cat"><span class="category-badge">${item.category}</span></td>
                    <td class="col-money">Rp ${moneyStr}</td>
                    <td style="text-align: right;">
                        <button onclick="window.editTrx('${item.id}')" class="action-btn edit" title="Edit"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="window.deleteTrx('${item.id}')" class="action-btn delete" title="Hapus"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateStats(data) {
            let total = 0;
            data.forEach(item => total += parseInt(item.amount));
            document.getElementById('total-expense').textContent = "Rp " + total.toLocaleString('id-ID');
            document.getElementById('total-trx').textContent = data.length;
        }

        // 4. SEARCH
        document.getElementById('search-input').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = pettyCashData.filter(item => 
                item.desc.toLowerCase().includes(term) || 
                item.category.toLowerCase().includes(term) ||
                item.amount.toString().includes(term)
            );
            renderTable(filtered);
        });

        // 5. UI HELPERS (Modal & Toast)
        window.openModal = () => {
            document.getElementById('trx-id').value = '';
            document.getElementById('trx-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('trx-desc').value = '';
            document.getElementById('trx-cat').value = 'Operasional';
            document.getElementById('trx-amount').value = '';
            document.getElementById('modal-title').textContent = 'Catat Pengeluaran Baru';
            
            const back = document.getElementById('modal-backdrop');
            const card = document.getElementById('modal-content');
            back.classList.add('active');
            card.classList.add('active');
        };

        window.closeModal = () => {
            document.getElementById('modal-backdrop').classList.remove('active');
            document.getElementById('modal-content').classList.remove('active');
        };

        function showToast(message) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').textContent = message;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // 6. CRUD ACTIONS
        window.saveTransaction = () => {
            const id = document.getElementById('trx-id').value;
            const date = document.getElementById('trx-date').value;
            const desc = document.getElementById('trx-desc').value;
            const cat = document.getElementById('trx-cat').value;
            const amount = document.getElementById('trx-amount').value;

            if(!date || !desc || !amount) return alert("Mohon lengkapi semua data.");

            const dataObj = { date, desc, category: cat, amount: parseInt(amount) };

            if(id) {
                set(ref(db, 'finance_pettycash/' + id), dataObj).then(() => {
                    window.closeModal();
                    showToast("Data berhasil diperbarui!");
                });
            } else {
                push(ref(db, 'finance_pettycash'), dataObj).then(() => {
                    window.closeModal();
                    showToast("Pengeluaran berhasil dicatat!");
                });
            }
        };

        window.editTrx = (id) => {
            const item = pettyCashData.find(i => i.id === id);
            if(item) {
                document.getElementById('trx-id').value = id;
                document.getElementById('trx-date').value = item.date;
                document.getElementById('trx-desc').value = item.desc;
                document.getElementById('trx-cat').value = item.category;
                document.getElementById('trx-amount').value = item.amount;
                document.getElementById('modal-title').textContent = 'Edit Pengeluaran';
                
                const back = document.getElementById('modal-backdrop');
                const card = document.getElementById('modal-content');
                back.classList.add('active');
                card.classList.add('active');
            }
        };

        window.deleteTrx = (id) => {
            if(confirm("Hapus catatan ini secara permanen?")) {
                remove(ref(db, 'finance_pettycash/' + id)).then(() => showToast("Data berhasil dihapus."));
            }
        };

        // Close modal on click outside
        document.getElementById('modal-backdrop').addEventListener('click', window.closeModal);
    </script>
</body>
</html>